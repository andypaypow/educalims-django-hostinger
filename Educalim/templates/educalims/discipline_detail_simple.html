{% extends 'base.html' %}

{% block title %}{{ discipline.nom }} - Educalim{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="fas fa-book-open"></i>
        {{ discipline.nom }}
    </h1>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'educalims:home' %}">Accueil</a></li>
            <li class="breadcrumb-item"><a href="{% url 'educalims:disciplines_list' %}">Disciplines</a></li>
            <li class="breadcrumb-item active">{{ discipline.nom }}</li>
        </ol>
    </nav>
</div>

<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-body">
                <p class="card-text">
                    Explorez les ressources éducatives disponibles pour la discipline
                    <strong>{{ discipline.nom }}</strong>. Les niveaux sont organisés par hiérarchie.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Affichage hiérarchique des niveaux -->
{% if niveaux_hierarchie %}
<div class="row">
    <div class="col-12">
        <h5 class="mb-4">Tous les niveaux disponibles avec leurs spécialités :</h5>

        {% for hierarchie in niveaux_hierarchie %}
        {% with parent=hierarchie.parent enfants=hierarchie.enfants %}
        <div class="mb-4">
            <!-- Niveau parent -->
            <div class="card border-primary {% if enfants %}parent-card{% endif %}" data-parent-id="{{ parent.id }}">
                <div class="card-header bg-primary text-white {% if enfants %}clickable-header{% endif %}"
                     {% if enfants %}onclick="toggleChildren({{ parent.id }})"{% endif %}>
                    <h5 class="mb-0 d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-graduation-cap"></i>
                            {{ parent.nom }}
                            {% if parent.type_enseignement %}
                            <span class="badge bg-light text-dark ms-2">{{ parent.type_enseignement }}</span>
                            {% endif %}
                            {% if enfants %}
                            <span class="badge bg-info text-dark ms-2">{{ enfants.count }} classe{{ enfants.count|pluralize }}</span>
                            {% endif %}
                            <span class="badge bg-secondary text-dark ms-2">{{ parent.cycle.nom }}</span>
                        </div>
                        {% if enfants %}
                        <i class="fas fa-chevron-down toggle-icon" id="icon-{{ parent.id }}"></i>
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text small text-muted">
                        {% if parent.cycle.nom == 'Collège' %}
                            {# Collège : afficher seulement les paliers #}
                            {% if parent.paliers.exists %}
                                {{ parent.paliers.count }} palier{{ parent.paliers.count|pluralize }}
                            {% else %}
                                <span class="text-warning">
                                    <i class="fas fa-clock"></i> Paliers bientôt disponibles
                                </span>
                            {% endif %}
                        {% elif parent.cycle.nom == 'Lycée' %}
                            {# Lycée : afficher seulement les parties #}
                            {% if parent.parties.exists %}
                                {{ parent.parties.count }} partie{{ parent.parties.count|pluralize }}
                            {% else %}
                                <span class="text-warning">
                                    <i class="fas fa-clock"></i> Parties bientôt disponibles
                                </span>
                            {% endif %}
                        {% endif %}
                    </p>

                    {% comment %}Afficher le nombre de chapitres disponibles selon le cycle{% endcomment %}
                    <p class="card-text small text-info">
                        {% if parent.cycle.nom == 'Collège' %}
                            {# Collège : compter les chapitres dans les paliers #}
                            {% if parent.paliers.exists %}
                                {% for palier in parent.paliers.all %}
                                    {% if not forloop.first %} • {% endif %}
                                    {% if palier.chapitres.exists %}
                                        {{ palier.chapitres.count }} chapitre{{ palier.chapitres.count|pluralize:"s" }}
                                    {% else %}
                                        0 chapitre (à venir)
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <i class="fas fa-clock"></i> Chapitres en préparation
                            {% endif %}
                        {% elif parent.cycle.nom == 'Lycée' %}
                            {# Lycée : compter les chapitres dans les parties #}
                            {% if parent.parties.exists %}
                                {% for partie in parent.parties.all %}
                                    {% if not forloop.first %} • {% endif %}
                                    {% if partie.chapitres.exists %}
                                        {{ partie.chapitres.count }} chapitre{{ partie.chapitres.count|pluralize:"s" }}
                                    {% else %}
                                        0 chapitre (à venir)
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <i class="fas fa-clock"></i> Chapitres en préparation
                            {% endif %}
                        {% endif %}
                    </p>

                    <div class="d-grid gap-2 d-md-flex">
                        <a href="{% url 'educalims:niveau_hierarchie' parent.id %}" class="btn btn-sm btn-primary">
                            <i class="fas fa-sitemap"></i> Navigation complète
                        </a>
                        <a href="{% url 'educalims:niveau_detail' parent.id %}" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-list"></i> Contenus détaillés
                        </a>
                    </div>
                </div>
            </div>

            <!-- Niveaux enfants (masqués par défaut) -->
            {% if enfants %}
            <div class="ms-4 children-container" id="children-{{ parent.id }}" style="display: none;">
                <div class="border-start border-4 border-success ps-3 mt-3">
                    <h6 class="text-muted mb-3">
                        <i class="fas fa-sitemap"></i> Classes et spécialités
                    </h6>
                    <div class="row">
                        {% for enfant in enfants %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card border-success h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        {{ enfant.nom }}
                                        {% if enfant.type_enseignement and enfant.type_enseignement != parent.type_enseignement %}
                                        <span class="badge bg-warning text-dark ms-1">{{ enfant.type_enseignement }}</span>
                                        {% endif %}
                                        <span class="badge bg-light text-dark ms-1">{{ enfant.cycle.nom }}</span>
                                    </h6>
                                    <p class="card-text small text-muted">
                                        {% if enfant.cycle.nom == 'Collège' %}
                                            {# Collège : afficher seulement les paliers #}
                                            {% if enfant.paliers.exists %}
                                                {{ enfant.paliers.count }} palier{{ enfant.paliers.count|pluralize }}
                                            {% else %}
                                                <span class="text-warning">
                                                    <i class="fas fa-clock"></i> Paliers à venir
                                                </span>
                                            {% endif %}
                                        {% elif enfant.cycle.nom == 'Lycée' %}
                                            {# Lycée : afficher seulement les parties #}
                                            {% if enfant.parties.exists %}
                                                {{ enfant.parties.count }} partie{{ enfant.parties.count|pluralize }}
                                            {% else %}
                                                <span class="text-warning">
                                                    <i class="fas fa-clock"></i> Parties à venir
                                                </span>
                                            {% endif %}
                                        {% endif %}
                                    </p>

                                    <p class="card-text small text-info">
                                        {% if enfant.cycle.nom == 'Collège' %}
                                            {# Collège : compter les chapitres dans les paliers #}
                                            {% if enfant.paliers.exists %}
                                                {% for palier in enfant.paliers.all %}
                                                    {% if not forloop.first %} • {% endif %}
                                                    {% if palier.chapitres.exists %}
                                                        {{ palier.chapitres.count }} chapitre{{ palier.chapitres.count|pluralize:"s" }}
                                                    {% else %}
                                                        0 chapitre (à venir)
                                                    {% endif %}
                                                {% endfor %}
                                            {% else %}
                                                <i class="fas fa-clock"></i> Chapitres en préparation
                                            {% endif %}
                                        {% elif enfant.cycle.nom == 'Lycée' %}
                                            {# Lycée : compter les chapitres dans les parties #}
                                            {% if enfant.parties.exists %}
                                                {% for partie in enfant.parties.all %}
                                                    {% if not forloop.first %} • {% endif %}
                                                    {% if partie.chapitres.exists %}
                                                        {{ partie.chapitres.count }} chapitre{{ partie.chapitres.count|pluralize:"s" }}
                                                    {% else %}
                                                        0 chapitre (à venir)
                                                    {% endif %}
                                                {% endfor %}
                                            {% else %}
                                                <i class="fas fa-clock"></i> Chapitres en préparation
                                            {% endif %}
                                        {% endif %}
                                    </p>

                                    <div class="d-grid gap-2">
                                        <a href="{% url 'educalims:niveau_hierarchie' enfant.id %}" class="btn btn-sm btn-success">
                                            <i class="fas fa-sitemap"></i> Explorer
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endwith %}
        {% endfor %}
    </div>
</div>
{% else %}
<div class="row">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-body text-center py-5">
                <i class="fas fa-clock fa-3x text-warning mb-3"></i>
                <h5 class="text-warning mb-3">Contenu bientôt disponible</h5>
                <p class="text-muted mb-4">
                    Les ressources pédagogiques pour la discipline <strong>{{ discipline.nom }}</strong>
                    sont en cours de préparation.
                </p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Ce qui sera disponible :</strong>
                    <ul class="mb-0 mt-2 text-start">
                        <li>Niveaux d'enseignement (Collège, Lycée)</li>
                        <li>Chapitres structurés par paliers et parties</li>
                        <li>Leçons et contenus pédagogiques</li>
                        <li>Ressources téléchargeables (PDF, vidéos)</li>
                    </ul>
                </div>
                <p class="text-muted small">
                    <i class="fas fa-sync-alt"></i>
                    Revenez consulter régulièrement cette page pour suivre les mises à jour.
                </p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="mt-4">
    <a href="{% url 'educalims:disciplines_list' %}" class="btn btn-outline-secondary me-2">
        <i class="fas fa-arrow-left"></i> Retour aux disciplines
    </a>
    {% if discipline.id %}
    <a href="{% url 'educalims:discipline_cycle' discipline.slug|default:'svt' 'college' %}" class="btn btn-outline-info me-2">
        <i class="fas fa-school"></i> Voir Collège
    </a>
    <a href="{% url 'educalims:discipline_cycle' discipline.slug|default:'svt' 'lycee' %}" class="btn btn-outline-info">
        <i class="fas fa-university"></i> Voir Lycée
    </a>
    {% endif %}
</div>

<!-- CSS et JavaScript pour l'accordéon -->
<style>
.clickable-header {
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.clickable-header:hover {
    background-color: rgba(255, 255, 255, 0.1) !important;
}

.parent-card {
    transition: transform 0.2s ease;
}

.parent-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.toggle-icon {
    transition: transform 0.3s ease;
}

.toggle-icon.rotated {
    transform: rotate(180deg);
}

.children-container {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<script>
function toggleChildren(parentId) {
    const childrenContainer = document.getElementById(`children-${parentId}`);
    const icon = document.getElementById(`icon-${parentId}`);

    if (childrenContainer.style.display === 'none') {
        childrenContainer.style.display = 'block';
        icon.classList.add('rotated');
    } else {
        childrenContainer.style.display = 'none';
        icon.classList.remove('rotated');
    }
}

// Empêcher le clic sur les liens de déclencher l'accordéon
document.addEventListener('DOMContentLoaded', function() {
    const parentCards = document.querySelectorAll('.parent-card');

    parentCards.forEach(card => {
        const links = card.querySelectorAll('a');
        const header = card.querySelector('.clickable-header');

        if (header) {
            links.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });
        }
    });
});
</script>

{% endblock %}
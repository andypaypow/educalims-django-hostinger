{% extends 'base.html' %}

{% block title %}{{ discipline.nom }} - {{ cycle_name }} - Educalim{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="fas fa-book-open"></i>
        {{ discipline.nom }} - {{ cycle_name }}
    </h1>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'educalims:home' %}">Accueil</a></li>
            <li class="breadcrumb-item"><a href="{% url 'educalims:disciplines_list' %}">Disciplines</a></li>
            <li class="breadcrumb-item active">{{ discipline.nom }} - {{ cycle_name }}</li>
        </ol>
    </nav>
</div>

<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-body">
                <p class="card-text">
                    Explorez les ressources éducatives disponibles pour <strong>{{ discipline.nom }}</strong>
                    au <strong>{{ cycle_name }}</strong>.
                </p>

                <!-- Navigation rapide entre collège et lycée -->
                <div class="btn-group" role="group">
                    {% if cycle_type == 'college' %}
                        <a href="{% url 'educalims:discipline_cycle' 'svt' 'college' %}" class="btn btn-primary active">
                            <i class="fas fa-school"></i> Collège
                        </a>
                        <a href="{% url 'educalims:discipline_cycle' 'svt' 'lycee' %}" class="btn btn-outline-primary">
                            <i class="fas fa-university"></i> Lycée
                        </a>
                    {% else %}
                        <a href="{% url 'educalims:discipline_cycle' 'svt' 'college' %}" class="btn btn-outline-primary">
                            <i class="fas fa-school"></i> Collège
                        </a>
                        <a href="{% url 'educalims:discipline_cycle' 'svt' 'lycee' %}" class="btn btn-primary active">
                            <i class="fas fa-university"></i> Lycée
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% if cycles %}
<div class="row">
    {% for cycle in cycles %}
    <div class="col-12">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-layer-group"></i>
                    {{ cycle.nom }}
                </h5>
            </div>
            <div class="card-body">
                {% if niveaux_hierarchie %}
                <h6 class="text-muted mb-3">Niveaux disponibles avec leurs spécialités :</h6>

                {% for hierarchie in niveaux_hierarchie %}
                {% with parent=hierarchie.parent enfants=hierarchie.enfants %}
                <div class="mb-4">
                    <!-- Niveau parent -->
                    <div class="card border-primary {% if enfants %}parent-card{% endif %}" data-parent-id="{{ parent.id }}">
                        <div class="card-header bg-primary text-white {% if enfants %}clickable-header{% endif %}"
                             {% if enfants %}onclick="toggleChildren({{ parent.id }})"{% endif %}>
                            <h5 class="mb-0 d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-graduation-cap"></i>
                                    {{ parent.nom }}
                                    {% if parent.type_enseignement %}
                                    <span class="badge bg-light text-dark ms-2">{{ parent.type_enseignement }}</span>
                                    {% endif %}
                                    {% if enfants %}
                                    <span class="badge bg-info text-dark ms-2">{{ enfants.count }} classe{{ enfants.count|pluralize }}</span>
                                    {% endif %}
                                </div>
                                {% if enfants %}
                                <i class="fas fa-chevron-down toggle-icon" id="icon-{{ parent.id }}"></i>
                                {% endif %}
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text small text-muted">
                                {% if cycle_type == 'college' %}
                                    {# Collège : afficher seulement les paliers #}
                                    {% if parent.paliers.exists %}
                                        {{ parent.paliers.count }} palier{{ parent.paliers.count|pluralize }}
                                    {% endif %}
                                {% elif cycle_type == 'lycee' %}
                                    {# Lycée : afficher seulement les parties #}
                                    {% if parent.parties.exists %}
                                        {{ parent.parties.count }} partie{{ parent.parties.count|pluralize }}
                                    {% endif %}
                                {% endif %}
                            </p>

                            {% comment %}Afficher le nombre de chapitres disponibles selon le cycle{% endcomment %}
                            <p class="card-text small text-info">
                                {% if cycle_type == 'college' %}
                                    {# Collège : compter les chapitres dans les paliers #}
                                    {% if parent.paliers.exists %}
                                        {% for palier in parent.paliers.all %}
                                            {% if not forloop.first %} • {% endif %}
                                            {{ palier.chapitres.count }} chapitre{{ palier.chapitres.count|pluralize:"s" }}
                                        {% endfor %}
                                    {% endif %}
                                {% elif cycle_type == 'lycee' %}
                                    {# Lycée : compter les chapitres dans les parties #}
                                    {% if parent.parties.exists %}
                                        {% for partie in parent.parties.all %}
                                            {% if not forloop.first %} • {% endif %}
                                            {{ partie.chapitres.count }} chapitre{{ partie.chapitres.count|pluralize:"s" }}
                                        {% endfor %}
                                    {% endif %}
                                {% endif %}
                            </p>

                            <div class="d-grid gap-2 d-md-flex">
                                <a href="{% url 'educalims:niveau_hierarchie' parent.id %}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-sitemap"></i> Navigation complète
                                </a>
                                <a href="{% url 'educalims:niveau_detail' parent.id %}" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-list"></i> Contenus détaillés
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Niveaux enfants (masqués par défaut) -->
                    {% if enfants %}
                    <div class="ms-4 children-container" id="children-{{ parent.id }}" style="display: none;">
                        <div class="border-start border-4 border-success ps-3 mt-3">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-sitemap"></i> Classes et spécialités
                            </h6>
                            <div class="row">
                                {% for enfant in enfants %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card border-success h-100">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                {{ enfant.nom }}
                                                {% if enfant.type_enseignement and enfant.type_enseignement != parent.type_enseignement %}
                                                <span class="badge bg-warning text-dark ms-1">{{ enfant.type_enseignement }}</span>
                                                {% endif %}
                                            </h6>
                                            <p class="card-text small text-muted">
                                                {% if cycle_type == 'college' %}
                                                    {# Collège : afficher seulement les paliers #}
                                                    {% if enfant.paliers.exists %}
                                                        {{ enfant.paliers.count }} palier{{ enfant.paliers.count|pluralize }}
                                                    {% endif %}
                                                {% elif cycle_type == 'lycee' %}
                                                    {# Lycée : afficher seulement les parties #}
                                                    {% if enfant.parties.exists %}
                                                        {{ enfant.parties.count }} partie{{ enfant.parties.count|pluralize }}
                                                    {% endif %}
                                                {% endif %}
                                            </p>

                                            <p class="card-text small text-info">
                                                {% if cycle_type == 'college' %}
                                                    {# Collège : compter les chapitres dans les paliers #}
                                                    {% if enfant.paliers.exists %}
                                                        {% for palier in enfant.paliers.all %}
                                                            {% if not forloop.first %} • {% endif %}
                                                            {{ palier.chapitres.count }} chapitre{{ palier.chapitres.count|pluralize:"s" }}
                                                        {% endfor %}
                                                    {% endif %}
                                                {% elif cycle_type == 'lycee' %}
                                                    {# Lycée : compter les chapitres dans les parties #}
                                                    {% if enfant.parties.exists %}
                                                        {% for partie in enfant.parties.all %}
                                                            {% if not forloop.first %} • {% endif %}
                                                            {{ partie.chapitres.count }} chapitre{{ partie.chapitres.count|pluralize:"s" }}
                                                        {% endfor %}
                                                    {% endif %}
                                                {% endif %}
                                            </p>

                                            <div class="d-grid gap-2">
                                                <a href="{% url 'educalims:niveau_hierarchie' enfant.id %}" class="btn btn-sm btn-success">
                                                    <i class="fas fa-sitemap"></i> Explorer
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endwith %}
                {% endfor %}

                {% else %}
                <p class="text-muted">Aucun niveau disponible pour ce cycle.</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="mt-4">
    <a href="{% url 'educalims:disciplines_list' %}" class="btn btn-outline-secondary me-2">
        <i class="fas fa-arrow-left"></i> Retour aux disciplines
    </a>
    <a href="{% url 'educalims:discipline' discipline.id %}" class="btn btn-outline-info">
        <i class="fas fa-eye"></i> Voir tous les cycles
    </a>
</div>

<!-- CSS et JavaScript pour l'accordéon -->
<style>
.clickable-header {
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.clickable-header:hover {
    background-color: rgba(255, 255, 255, 0.1) !important;
}

.parent-card {
    transition: transform 0.2s ease;
}

.parent-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.toggle-icon {
    transition: transform 0.3s ease;
}

.toggle-icon.rotated {
    transform: rotate(180deg);
}

.children-container {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<script>
function toggleChildren(parentId) {
    const childrenContainer = document.getElementById(`children-${parentId}`);
    const icon = document.getElementById(`icon-${parentId}`);

    if (childrenContainer.style.display === 'none') {
        childrenContainer.style.display = 'block';
        icon.classList.add('rotated');
    } else {
        childrenContainer.style.display = 'none';
        icon.classList.remove('rotated');
    }
}

// Empêcher le clic sur les liens de déclencher l'accordéon
document.addEventListener('DOMContentLoaded', function() {
    const parentCards = document.querySelectorAll('.parent-card');

    parentCards.forEach(card => {
        const links = card.querySelectorAll('a');
        const header = card.querySelector('.clickable-header');

        if (header) {
            links.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });
        }
    });
});
</script>

{% endblock %}
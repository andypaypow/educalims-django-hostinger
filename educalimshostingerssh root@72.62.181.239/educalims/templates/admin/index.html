{% extends "admin/index.html" %}

{% block extrahead %}
{{ block.super }}
<style>
.payment-notifications {
    background: #f8f9fa;
    border: 2px solid #0d6efd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}
.payment-notifications h3 {
    color: #0d6efd;
    margin-top: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}
.payment-item {
    padding: 10px;
    margin: 5px 0;
    border-radius: 4px;
    background: white;
    border-left: 4px solid #dee2e6;
}
.payment-item.success {
    background: #d1e7dd;
    border-left-color: #198754;
}
.payment-item.pending {
    background: #fff3cd;
    border-left-color: #ffc107;
}
.payment-item.failed {
    background: #f8d7da;
    border-left-color: #dc3545;
}
.payment-time {
    font-size: 12px;
    color: #6c757d;
}
.payment-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.badge-status {
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: bold;
}
.badge-success { background: #198754; color: white; }
.badge-pending { background: #ffc107; color: #000; }
.badge-failed { background: #dc3545; color: white; }
.no-payments {
    text-align: center;
    padding: 20px;
    color: #6c757d;
}
.refresh-indicator {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #0d6efd;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
<script>
function loadPayments() {
    fetch('/api/paiements-recents/')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('payments-container');
            if (data.paiements.length === 0) {
                container.innerHTML = '<div class="no-payments"><i class="bi bi-inbox"></i> Aucun paiement recent</div>';
                return;
            }

            let html = '';
            data.paiements.forEach(p => {
                let statusClass = 'pending';
                let badgeClass = 'badge-pending';
                let icon = '⏳';

                if (p.statut === 'ACTIF') {
                    statusClass = 'success';
                    badgeClass = 'badge-success';
                    icon = '✅';
                } else if (p.statut === 'ECHOUE') {
                    statusClass = 'failed';
                    badgeClass = 'badge-failed';
                    icon = '❌';
                }

                html += `
                    <div class="payment-item ${statusClass}">
                        <div class="payment-details">
                            <div>
                                <strong>${icon} ${p.user}</strong> - ${p.niveau}
                                ${p.montant ? `<span style="color: #0d6efd; font-weight: bold;">${p.montant} FCFA</span>` : ''}
                                ${p.methode ? `<span style="font-size: 11px; background: #e9ecef; padding: 2px 6px; border-radius: 3px;">${p.methode}</span>` : ''}
                            </div>
                            <div>
                                <span class="badge-status ${badgeClass}">${p.statut_display}</span>
                                <span class="payment-time">${p.date_modification}</span>
                            </div>
                        </div>
                        ${p.merchant_reference_id ? `<small style="color: #6c757d;">Ref: ${p.merchant_reference_id}</small>` : ''}
                        ${p.code_paiement ? `<small style="color: #6c757d;"> | Code: ${p.code_paiement}</small>` : ''}
                    </div>
                `;
            });
            container.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading payments:', error);
        });
}

// Charger les paiements au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    loadPayments();
    // Rafraichir toutes les 10 secondes
    setInterval(loadPayments, 10000);
});
</script>
{% endblock %}

{% block content %}
{{ block.super }}

<div class="payment-notifications">
    <h3>
        <i class="bi bi-bell"></i>
        Notifications de paiement
        <span class="refresh-indicator" style="margin-left: 10px;"></span>
    </h3>
    <p style="color: #6c757d; margin-bottom: 15px;">
        <i class="bi bi-info-circle"></i> Derniers paiements des 10 dernières minutes (rafraîchissement auto: 10s)
    </p>
    <div id="payments-container">
        <div class="no-payments"><span class="refresh-indicator"></span> Chargement...</div>
    </div>
</div>
{% endblock %}

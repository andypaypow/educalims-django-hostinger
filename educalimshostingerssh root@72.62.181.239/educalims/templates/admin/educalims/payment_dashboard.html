{% extends "admin/base_site.html" %}

{% block title %}{{ title }} - {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">Accueil</a>
&rsaquo; {{ title }}
</div>
{% endblock %}

{% block content %}
<h1>{{ title }}</h1>

<!-- Statistiques globales -->
<div style="display: flex; gap: 20px; margin-bottom: 30px;">
    <div style="flex: 1; background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
        <h3 style="margin: 0 0 10px 0; color: #856404;">En attente</h3>
        <div style="font-size: 36px; font-weight: bold; color: #856404;">{{ total_attente }}</div>
    </div>
    <div style="flex: 1; background: #d1e7dd; padding: 20px; border-radius: 8px; border-left: 4px solid #198754;">
        <h3 style="margin: 0 0 10px 0; color: #0f5132;">Actifs</h3>
        <div style="font-size: 36px; font-weight: bold; color: #0f5132;">{{ total_actifs }}</div>
    </div>
    <div style="flex: 1; background: #f8d7da; padding: 20px; border-radius: 8px; border-left: 4px solid #dc3545;">
        <h3 style="margin: 0 0 10px 0; color: #842029;">Echoues</h3>
        <div style="font-size: 36px; font-weight: bold; color: #842029;">{{ total_echoues }}</div>
    </div>
</div>

<!-- Abonnements en attente -->
{% if abonnements_attente %}
<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
    <h2 style="color: #856404; margin-top: 0;">
        <i class="icon-clock"></i> Paiements en attente ({{ abonnements_attente|length }})
    </h2>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #ffc107;">
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">User</th>
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Niveau</th>
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Ref Marchand</th>
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Date</th>
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Action</th>
            </tr>
        </thead>
        <tbody>
            {% for abo in abonnements_attente %}
            <tr style="background: white;">
                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">{{ abo.user.username }}</td>
                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">{{ abo.niveau.nom }}</td>
                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;"><code>{{ abo.merchant_reference_id|default:"N/A" }}</code></td>
                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">{{ abo.date_creation|date:"d/m/Y H:i" }}</td>
                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">
                    <a href="/admin/educalims/abonnement/{{ abo.id }}/change/" style="color: #0d6efd;">Voir</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Abonnements actifs recents -->
{% if abonnements_actifs %}
<div style="background: #d1e7dd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
    <h2 style="color: #0f5132; margin-top: 0;">
        <i class="icon-success"></i> Paiements reussis recents ({{ abonnements_actifs|length }})
    </h2>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #198754;">
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">User</th>
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Niveau</th>
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Montant</th>
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Methode</th>
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Date activation</th>
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Fin</th>
            </tr>
        </thead>
        <tbody>
            {% for abo in abonnements_actifs %}
            <tr style="background: white;">
                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">{{ abo.user.username }}</td>
                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">{{ abo.niveau.nom }}</td>
                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">{{ abo.montant_paye|default:"N/A" }} FCFA</td>
                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">{{ abo.methode_paiement|default:"N/A" }}</td>
                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">{{ abo.date_debut|date:"d/m/Y H:i" }}</td>
                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">{{ abo.date_fin|date:"d/m/Y" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Derniers abonnements -->
<div style="background: #e9ecef; padding: 15px; border-radius: 8px;">
    <h2 style="margin-top: 0;">Derniers abonnements ({{ derniers_abonnements|length }})</h2>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr>
                <th style="padding: 10px; text-align: left; background: #dee2e6; border-bottom: 2px solid #adb5bd;">User</th>
                <th style="padding: 10px; text-align: left; background: #dee2e6; border-bottom: 2px solid #adb5bd;">Niveau</th>
                <th style="padding: 10px; text-align: left; background: #dee2e6; border-bottom: 2px solid #adb5bd;">Statut</th>
                <th style="padding: 10px; text-align: left; background: #dee2e6; border-bottom: 2px solid #adb5bd;">Ref Marchand</th>
                <th style="padding: 10px; text-align: left; background: #dee2e6; border-bottom: 2px solid #adb5bd;">Code</th>
                <th style="padding: 10px; text-align: left; background: #dee2e6; border-bottom: 2px solid #adb5bd;">Date</th>
            </tr>
        </thead>
        <tbody>
            {% for abo in derniers_abonnements %}
            <tr style="background: {% if abo.statut == 'ACTIF' %}#d1e7dd{% elif abo.statut == 'EN_ATTENTE' %}#fff3cd{% elif abo.statut == 'ECHOUE' %}#f8d7da{% else %}white{% endif %};">
                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">{{ abo.user.username }}</td>
                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">{{ abo.niveau.nom }}</td>
                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">
                    <span style="padding: 3px 8px; border-radius: 4px; font-size: 12px;
                        {% if abo.statut == 'ACTIF' %}background: #198754; color: white;
                        {% elif abo.statut == 'EN_ATTENTE' %}background: #ffc107; color: #000;
                        {% elif abo.statut == 'ECHOUE' %}background: #dc3545; color: white;
                        {% endif %}">
                        {{ abo.get_statut_display }}
                    </span>
                </td>
                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;"><code>{{ abo.merchant_reference_id|default:"N/A" }}</code></td>
                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">{{ abo.code_paiement|default:"-" }}</td>
                <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">{{ abo.date_creation|date:"d/m/Y H:i" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div style="margin-top: 30px;">
    <a href="/admin/educalims/abonnement/" class="button" style="display: inline-block; padding: 10px 20px; background: #0d6efd; color: white; text-decoration: none; border-radius: 4px;">
        Voir tous les abonnements
    </a>
</div>

<!-- Rafraichissement automatique -->
<script>
// Rafraichir toutes les 30 secondes
setTimeout(function() {
    location.reload();
}, 30000);
</script>

<style>
.button:hover {
    background: #0b5ed7 !important;
}
</style>
{% endblock %}
